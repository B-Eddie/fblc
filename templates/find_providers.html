{% extends "base.html" %} 
{% block content %}
<div class="p-10">
  <h1 class="mb-8 text-3xl font-bold text-orange-600">
    Find Healthcare Providers
  </h1>

  <div class="mb-8">
    <div class="flex flex-wrap gap-4 mb-4">
      <button
        id="filterAll"
        class="px-4 py-2 font-bold text-black transition duration-300 bg-orange-500 rounded-full hover:bg-orange-600"
      >
        All
      </button>
      <button
        id="filterDentist"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        Dentist
      </button>
      <button
        id="filterOptometrist"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        Optometrist
      </button>
      <button
        id="filterGP"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        General Practitioner
      </button>
      <button
        id="filterPediatrician"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        Pediatrician
      </button>
      <button
        id="filterDermatologist"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        Dermatologist
      </button>
    </div>
    <div class="flex items-center gap-4">
      <label for="sortDistance" class="font-medium text-orange-800"
        >Sort by distance:</label
      >
      <select
        id="sortDistance"
        class="p-2 text-orange-800 border border-orange-300 rounded-md bg-orange-50"
      >
        <option value="asc">Nearest first</option>
        <option value="desc">Farthest first</option>
      </select>
    </div>
  </div>

  <div id="providerList" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    <!-- Provider cards will be dynamically inserted here -->
  </div>

  <!-- Modal for booking appointments -->
  <div
    id="bookingModal"
    class="fixed inset-0 items-center justify-center hidden bg-gray-600 bg-opacity-50"
  >
    <!-- Modal content -->
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const providerList = document.getElementById("providerList");
      const filterButtons = document.querySelectorAll('[id^="filter"]');
      const sortDistance = document.getElementById("sortDistance");
      const modal = document.getElementById("bookingModal");
      const closeModal = document.getElementById("closeModal");
      const bookingForm = document.getElementById("bookingForm");
      let map = null; // Initialize the map variable

      // Initialize HERE platform globally
      const platform = new H.service.Platform({
        apikey: "lUFTE1skWuIcrj_s0wCZbbM2KWcgT2JnJcKGWHFi4WA",
      });

      let providers = [];
      let userLocation = {
        lat: 37.7749,
        lng: -122.4194,
      };

      // Get user's location and fetch providers
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            fetchProviders();
          },
          (error) => {
            console.warn("Geolocation error:", error);
            fetchProviders();
          }
        );
      } else {
        fetchProviders();
      }

      function fetchProviders(specialty = null) {
        let url = `/api/providers?lat=${userLocation.lat}&lng=${userLocation.lng}`;
        if (specialty) {
          url += `&specialty=${specialty}`;
        }
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            providers = data;
            renderProviders(providers);
          })
          .catch((error) => console.error("Error:", error));
      }

      function initializeProviderMap(mapDivId, address) {
        const defaultLayers = platform.createDefaultLayers();
        const providerMap = new H.Map(
          document.getElementById(mapDivId),
          defaultLayers.vector.normal.map,
          {
            zoom: 15,
            pixelRatio: window.devicePixelRatio || 1,
            center: { lat: userLocation.lat, lng: userLocation.lng },
          }
        );

        const behavior = new H.mapevents.Behavior(
          new H.mapevents.MapEvents(providerMap)
        );

        const geocoder = platform.getSearchService();
        geocoder.geocode(
          {
            q: address,
            at: `${userLocation.lat},${userLocation.lng}`,
          },
          (result) => {
            if (result.items.length > 0) {
              const coords = result.items[0].position;
              providerMap.setCenter({ lat: coords.lat, lng: coords.lng });
              const marker = new H.map.Marker({
                lat: coords.lat,
                lng: coords.lng,
              });
              providerMap.addObject(marker);
            }
          },
          (error) => console.error("Geocoding error:", error)
        );

        window.addEventListener("resize", () =>
          providerMap.getViewPort().resize()
        );
      }

      function renderProviders(providersToRender) {
        providerList.innerHTML = "";
        providersToRender.forEach((provider) => {
          const card = document.createElement("div");
          card.className =
            "bg-white shadow-lg rounded-lg border border-orange-200 overflow-hidden transition duration-300 transform hover:scale-105";

          const mapDivId = `map-${provider.id}`;
          const distance = provider.distance
            ? `${provider.distance.toFixed(1)} miles away`
            : "Distance calculating...";

          card.innerHTML = `
            <div id="${mapDivId}" class="w-full h-48"></div>
            <div class="p-6">
              <h3 class="mb-2 text-lg font-semibold text-orange-600">${provider.name}</h3>
              <p class="mb-2 text-gray-600">${provider.specialty}</p>
              <p class="mb-2 text-gray-600">${provider.address}</p>
              <p class="mb-4 text-gray-600">${distance}</p>
              <button class="px-4 py-2 font-bold text-white transition duration-300 bg-orange-500 rounded-full hover:bg-orange-600 book-appointment" data-id="${provider.id}">
                Book Appointment
              </button>
            </div>
          `;

          providerList.appendChild(card);
          initializeProviderMap(mapDivId, provider.address);
        });

        // Add event listeners to book appointment buttons
        document.querySelectorAll(".book-appointment").forEach((button) => {
          button.addEventListener("click", (e) => {
            const providerId = e.target.getAttribute("data-id");
            openBookingModal(providerId);
          });
        });
      }

      // Add event listeners to filter buttons
      filterButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const specialty = button.id.replace("filter", "");
          fetchProviders(specialty === "All" ? null : specialty);
        });
      });

      // Rest of the script remains unchanged...
    });
  </script>
</div>
{% endblock %}