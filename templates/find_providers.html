{% extends "base.html" %} {% block content %}
<div class="p-10">
  <h1 class="mb-8 text-3xl font-bold text-orange-600">
    Find Healthcare Providers
  </h1>

  <div class="mb-8">
    <div class="flex flex-wrap gap-4 mb-4">
      <button
        id="filterAll"
        class="px-4 py-2 font-bold text-black transition duration-300 bg-orange-500 rounded-full hover:bg-orange-600"
      >
        All
      </button>
      <button
        id="filterDentist"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        Dentist
      </button>
      <button
        id="filterOptometrist"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        Optometrist
      </button>
      <button
        id="filterGP"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        General Practitioner
      </button>
      <button
        id="filterPediatrician"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        Pediatrician
      </button>
      <button
        id="filterDermatologist"
        class="px-4 py-2 font-bold text-orange-800 transition duration-300 bg-orange-100 rounded-full hover:bg-orange-200"
      >
        Dermatologist
      </button>
    </div>
    <div class="flex items-center gap-4">
      <label for="sortDistance" class="font-medium text-orange-800"
        >Sort by distance:</label
      >
      <select
        id="sortDistance"
        class="p-2 text-orange-800 border border-orange-300 rounded-md bg-orange-50"
      >
        <option value="asc">Nearest first</option>
        <option value="desc">Farthest first</option>
      </select>
    </div>
  </div>

  <div id="providerList" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    <!-- Provider cards will be dynamically inserted here -->
  </div>

  <!-- Modal for booking appointments -->
  <div
    id="bookingModal"
    class="fixed inset-0 items-center justify-center hidden bg-gray-600 bg-opacity-50"
  >
    <div class="w-full max-w-md p-8 bg-orange-200 rounded-lg shadow-xl">
      <h2 id="modalTitle" class="mb-4 text-2xl font-bold text-orange-600"></h2>
      <div
        id="modalMap"
        class="w-full h-48 mb-4 rounded-lg"
        style="min-height: 200px"
      ></div>
      <p id="modalSpecialty" class="mb-2 text-gray-600"></p>
      <p id="modalAddress" class="mb-2 text-gray-600"></p>
      <p id="modalPhone" class="mb-4 text-gray-600"></p>
      <form id="bookingForm" class="space-y-4">
        <div>
          <label
            for="appointmentDate"
            class="block text-sm font-medium text-gray-700"
            >Date</label
          >
          <input
            type="date"
            id="appointmentDate"
            name="appointmentDate"
            required
            class="block w-full p-2 mt-1 border border-orange-300 rounded-md shadow-sm"
          />
        </div>
        <div>
          <label
            for="appointmentTime"
            class="block text-sm font-medium text-gray-700"
            >Time</label
          >
          <input
            type="time"
            id="appointmentTime"
            name="appointmentTime"
            required
            class="block w-full p-2 mt-1 border border-orange-300 rounded-md shadow-sm"
          />
        </div>
        <div>
          <label
            for="appointmentType"
            class="block text-sm font-medium text-gray-700"
            >Appointment Type</label
          >
          <input
            type="text"
            id="appointmentType"
            name="appointmentType"
            required
            class="block w-full p-2 mt-1 border border-orange-300 rounded-md shadow-sm"
          />
        </div>
        <div class="flex justify-end space-x-4">
          <button
            type="button"
            id="closeModal"
            class="px-4 py-2 font-bold text-gray-800 transition duration-300 bg-gray-300 rounded-full hover:bg-gray-400"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 font-bold text-black transition duration-300 bg-orange-500 rounded-full hover:bg-orange-600"
          >
            Book Appointment
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const providerList = document.getElementById("providerList");
      const filterButtons = document.querySelectorAll('[id^="filter"]');
      const sortDistance = document.getElementById("sortDistance");
      const modal = document.getElementById("bookingModal");
      const closeModal = document.getElementById("closeModal");
      const bookingForm = document.getElementById("bookingForm");

      // Initialize HERE platform globally
      const platform = new H.service.Platform({
        apikey: "lUFTE1skWuIcrj_s0wCZbbM2KWcgT2JnJcKGWHFi4WA",
      });

      let providers = [];
      let userLocation = {
        lat: 37.7749,
        lng: -122.4194,
      };

      // Get user's location and fetch providers
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            fetchProviders();
          },
          (error) => {
            console.warn("Geolocation error:", error);
            fetchProviders();
          }
        );
      } else {
        fetchProviders();
      }

      function fetchProviders() {
        fetch(`/api/providers?lat=${userLocation.lat}&lng=${userLocation.lng}`)
          .then((response) => response.json())
          .then((data) => {
            providers = data;
            renderProviders(providers);
          })
          .catch((error) => console.error("Error:", error));
      }

      function initializeProviderMap(mapDivId, address) {
        const defaultLayers = platform.createDefaultLayers();
        const providerMap = new H.Map(
          document.getElementById(mapDivId),
          defaultLayers.vector.normal.map,
          {
            zoom: 15,
            pixelRatio: window.devicePixelRatio || 1,
            center: { lat: userLocation.lat, lng: userLocation.lng },
          }
        );

        const behavior = new H.mapevents.Behavior(
          new H.mapevents.MapEvents(providerMap)
        );

        const geocoder = platform.getSearchService();
        geocoder.geocode(
          {
            q: address,
            at: `${userLocation.lat},${userLocation.lng}`,
          },
          (result) => {
            if (result.items.length > 0) {
              const coords = result.items[0].position;
              providerMap.setCenter({ lat: coords.lat, lng: coords.lng });
              const marker = new H.map.Marker({
                lat: coords.lat,
                lng: coords.lng,
              });
              providerMap.addObject(marker);
            }
          },
          (error) => console.error("Geocoding error:", error)
        );

        window.addEventListener("resize", () =>
          providerMap.getViewPort().resize()
        );
      }

      function renderProviders(providersToRender) {
        providerList.innerHTML = "";
        providersToRender.forEach((provider) => {
          const card = document.createElement("div");
          card.className =
            "bg-white shadow-lg rounded-lg border border-orange-200 overflow-hidden transition duration-300 transform hover:scale-105";

          const mapDivId = `map-${provider.id}`;
          const distance = provider.distance
            ? `${provider.distance.toFixed(1)} miles away`
            : "Distance calculating...";

          card.innerHTML = `
            <div id="${mapDivId}" class="w-full h-48"></div>
            <div class="p-6">
              <h3 class="mb-2 text-lg font-semibold text-orange-600">${provider.name}</h3>
              <p class="mb-2 text-gray-600">${provider.specialty}</p>
              <p class="mb-2 text-gray-600">${provider.address}</p>
              <p class="mb-4 text-gray-600">${distance}</p>
              <button class="px-4 py-2 font-bold text-white transition duration-300 bg-orange-500 rounded-full hover:bg-orange-600 book-appointment" data-id="${provider.id}">
                Book Appointment
              </button>
            </div>
          `;

          providerList.appendChild(card);
          initializeProviderMap(mapDivId, provider.address);
        });

        // Add event listeners to book appointment buttons
        document.querySelectorAll(".book-appointment").forEach((button) => {
          button.addEventListener("click", (e) => {
            const providerId = e.target.getAttribute("data-id");
            openBookingModal(providerId);
          });
        });
      }

      // Open booking modal and initialize modal map
      function openBookingModal(providerId) {
        fetch(`/api/provider/${providerId}`)
          .then((response) => response.json())
          .then((provider) => {
            document.getElementById("modalTitle").textContent = provider.name;
            document.getElementById("modalSpecialty").textContent =
              provider.specialty;
            document.getElementById("modalAddress").textContent =
              provider.address;
            document.getElementById("modalPhone").textContent = provider.phone;

            // Initialize map if not already done
            if (!map) {
              const defaultLayers = platform.createDefaultLayers();
              map = new H.Map(
                document.getElementById("modalMap"),
                defaultLayers.vector.normal.map,
                {
                  zoom: 15,
                  pixelRatio: window.devicePixelRatio || 1,
                }
              );

              // Enable map interactions
              const behavior = new H.mapevents.Behavior(
                new H.mapevents.MapEvents(map)
              );
              const ui = H.ui.UI.createDefault(map, defaultLayers);

              // Make map responsive
              window.addEventListener("resize", () =>
                map.getViewPort().resize()
              );
            }

            // Geocode the provider address and center the modal map.
            // The "at" parameter is added to satisfy the HERE API requirement.
            const geocoder = platform.getSearchService();
            geocoder.geocode(
              {
                q: provider.address,
                at: "37.7749,-122.4194", // Replace with coordinates relevant to your area
              },
              (result) => {
                if (result.items.length > 0) {
                  const coords = result.items[0].position;
                  map.setCenter({ lat: coords.lat, lng: coords.lng });

                  // Add a marker
                  const marker = new H.map.Marker({
                    lat: coords.lat,
                    lng: coords.lng,
                  });
                  map.removeObjects(map.getObjects()); // Clear existing markers
                  map.addObject(marker);
                } else {
                  console.warn(
                    "No results found for the given address in modal."
                  );
                }
              },
              (error) => {
                console.error("Geocoding error in modal:", error);
              }
            );

            modal.classList.remove("hidden");
            modal.classList.add("flex");
          });
      }

      // Close modal
      closeModal.addEventListener("click", () => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      });

      // Handle booking form submission
      bookingForm.addEventListener("submit", (e) => {
        e.preventDefault();
        // Here you would typically send the booking data to your server
        alert("Appointment booked successfully!");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      });
    });
  </script>
</div>
{% endblock %}
