{% extends "base.html" %} {% block content %}
<div class="p-10">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold text-orange-600">Manage Your Business</h1>
    <a
      href="{{ url_for('add_business') }}"
      class="px-4 py-2 font-bold text-white transition duration-300 bg-orange-600 rounded-lg hover:bg-orange-700"
    >
      <div class="flex items-center">
        <svg
          class="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"
          ></path>
        </svg>
        Add New Business
      </div>
    </a>
  </div>

  {% if businesses %}
  <!-- Business cards section -->
  <div class="grid gap-6 mb-12 md:grid-cols-2 lg:grid-cols-3">
    {% for business in businesses %}
    <div
      class="p-6 transition duration-300 bg-white border border-orange-200 rounded-lg shadow-md hover:shadow-lg business-card"
      data-id="{{ business.id }}"
    >
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-orange-600">
          {{ business.name }}
        </h2>
        <span
          class="px-3 py-1 text-sm {% if business.verified %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %} rounded-full"
        >
          {% if business.verified %}Verified{% else %}Pending Verification{%
          endif %}
        </span>
      </div>

      <p class="mb-2 text-gray-700">
        <span class="font-medium">Specialty:</span> {{ business.specialty }}
      </p>
      <p class="mb-2 text-gray-700">
        <span class="font-medium">Address:</span> {{ business.address }}
      </p>
      <p class="mb-2 text-gray-700">
        <span class="font-medium">Phone:</span> {{ business.phone }}
      </p>

      <div class="flex justify-between mt-6 business-actions">
        <a
          href="{{ url_for('edit_business', business_id=business.id) }}"
          class="px-3 py-2 text-sm font-medium text-black transition duration-300 bg-blue-100 border border-blue-500 rounded hover:bg-blue-200"
        >
          Edit Details
        </a>
        <button
          onclick="confirmDelete('{{ business.id }}')"
          class="px-3 py-2 text-sm font-medium text-black transition duration-300 bg-red-100 border border-red-500 rounded hover:bg-red-200"
        >
          Delete
        </button>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Appointment Management Section -->
  <div class="mt-12">
    <h2 class="mb-6 text-2xl font-bold text-orange-600">
      <div class="flex items-center">
        <svg
          class="w-6 h-6 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
          ></path>
        </svg>
        Appointment Management
      </div>
    </h2>

    <!-- Business selector for appointments -->
    <div class="mb-6">
      <label
        for="business-selector"
        class="block text-sm font-medium text-gray-700"
        >Select Business</label
      >
      <select
        id="business-selector"
        class="block w-full py-2 pl-3 pr-10 mt-1 text-base border-gray-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
      >
        {% for business in businesses %}
        <option value="{{ business.id }}">{{ business.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Filter controls -->
    <div class="flex flex-wrap gap-4 mb-6">
      <div class="flex-1">
        <label
          for="date-filter"
          class="block text-sm font-medium text-gray-700"
        >
          Date Range
        </label>
        <select
          id="date-filter"
          class="block w-full px-3 py-2 mt-1 text-base border-gray-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
        >
          <option value="all">All Dates</option>
          <option value="today">Today</option>
          <option value="tomorrow">Tomorrow</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
        </select>
      </div>
      <div class="flex-1">
        <label
          for="status-filter"
          class="block text-sm font-medium text-gray-700"
        >
          Status
        </label>
        <select
          id="status-filter"
          class="block w-full px-3 py-2 mt-1 text-base border-gray-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
        >
          <option value="all">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="flex-1">
        <label
          for="search-appointments"
          class="block text-sm font-medium text-gray-700"
        >
          Search
        </label>
        <input
          type="text"
          id="search-appointments"
          class="block w-full px-3 py-2 mt-1 border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
          placeholder="Search by name or type..."
        />
      </div>
    </div>

    <div class="flex items-center justify-between mb-4">
      <p class="text-sm text-gray-600">
        Showing <span id="appointment-count">0</span> appointments
      </p>
      <button
        id="export-csv"
        class="px-3 py-2 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700"
      >
        <svg
          class="inline w-4 h-4 mr-1"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
          ></path>
        </svg>
        Export to CSV
      </button>
    </div>

    <!-- Appointment data table -->
    <div class="overflow-x-auto rounded-lg shadow">
      <table class="min-w-full bg-white divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th
              scope="col"
              class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase"
            >
              Client
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase"
            >
              Date & Time
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase"
            >
              Type
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase"
            >
              Status
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase"
            >
              Contact
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-xs font-medium tracking-wider text-center text-gray-500 uppercase"
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody id="appointments-table-body" class="divide-y divide-gray-200">
          <!-- Appointments will be loaded here via JavaScript -->
          <tr>
            <td colspan="6" class="px-6 py-4 text-sm text-center text-gray-500">
              Loading appointments...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between px-4 mt-6">
      <div class="flex items-center justify-between flex-1">
        <div>
          <p class="text-sm text-gray-700">
            Showing
            <span class="font-medium" id="page-start">1</span>
            to
            <span class="font-medium" id="page-end">10</span>
            of
            <span class="font-medium" id="total-results">20</span>
            appointments
          </p>
        </div>
        <div>
          <nav
            class="relative z-0 inline-flex -space-x-px rounded-md shadow-sm"
            aria-label="Pagination"
            id="pagination-container"
          >
            <!-- Pagination will be generated here -->
          </nav>
        </div>
      </div>
    </div>
  </div>
  <br /><br />
  <!-- Calendar View -->
  <div class="mt-12">
    <h2 class="mb-6 text-2xl font-bold text-orange-600">
      <div class="flex items-center">
        <svg
          class="w-6 h-6 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
          ></path>
        </svg>
        Calendar View
      </div>
    </h2>

    <div class="p-5 bg-white rounded-lg shadow">
      <!-- Calendar will be rendered here -->
      <div id="calendar" class="fc fc-media-screen fc-direction-ltr"></div>

      <!-- Calendar Legend -->
      <div
        style="
          margin-top: 1rem;
          display: flex;
          flex-wrap: wrap;
          gap: 1rem;
          justify-content: center;
          font-size: 0.875rem;
        "
      >
        <div style="display: flex; align-items: center">
          <span
            style="
              width: 12px;
              height: 12px;
              border-radius: 50%;
              background-color: #00ff00;
              margin-right: 0.5rem;
            "
          ></span>
          <span>Confirmed</span>
        </div>
        <div style="display: flex; align-items: center">
          <span
            style="
              width: 12px;
              height: 12px;
              border-radius: 50%;
              background-color: #ffff00;
              margin-right: 0.5rem;
            "
          ></span>
          <span>Pending</span>
        </div>
        <div style="display: flex; align-items: center">
          <span
            style="
              width: 12px;
              height: 12px;
              border-radius: 50%;
              background-color: #ff0000;
              margin-right: 0.5rem;
            "
          ></span>
          <span>Cancelled</span>
        </div>
        <div style="display: flex; align-items: center">
          <span
            style="
              width: 12px;
              height: 12px;
              border-radius: 50%;
              background-color: #0000ff;
              margin-right: 0.5rem;
            "
          ></span>
          <span>Completed</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Appointment Detail Modal -->
  <div
    id="appointment-modal"
    class="fixed inset-0 z-50 flex items-center justify-center hidden p-4 overflow-y-auto bg-black bg-opacity-50 md:p-0"
  >
    <div
      class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto relative"
    >
      <!-- Header -->
      <div
        class="sticky top-0 z-10 flex items-center justify-between p-4 bg-white border-b md:p-6"
      >
        <h3 class="text-lg font-medium text-gray-900">Appointment Details</h3>
        <button
          onclick="closeAppointmentModal()"
          class="p-1 text-gray-400 rounded-full hover:text-gray-500 hover:bg-gray-100"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Content -->
      <div id="appointment-details" class="p-4 md:p-6">
        <!-- Appointment details will be injected here -->
      </div>

      <!-- Footer with action buttons -->
      <div
        class="sticky bottom-0 z-10 flex flex-wrap justify-end gap-2 p-3 md:gap-3 md:px-6 md:py-3 bg-gray-50"
      >
        <button
          id="modal-cancel"
          class="flex-1 px-3 py-2 text-sm text-red-800 bg-red-500 border border-red-300 rounded-md md:text-base hover:bg-red-200 md:flex-none"
        >
          <span class="flex items-center justify-center">
            <svg
              class="w-4 h-4 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
            Cancel
          </span>
        </button>
        <button
          id="modal-confirm"
          class="flex-1 px-3 py-2 text-sm text-green-800 bg-green-100 border border-green-300 rounded-md md:text-base hover:bg-green-200 md:flex-none"
        >
          <span class="flex items-center justify-center">
            <svg
              class="w-4 h-4 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
            Confirm
          </span>
        </button>
        <button
          id="modal-complete"
          class="flex-1 px-3 py-2 text-sm text-blue-800 bg-blue-100 border border-blue-300 rounded-md md:text-base hover:bg-blue-200 md:flex-none"
        >
          <span class="flex items-center justify-center">
            <svg
              class="w-4 h-4 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            Complete
          </span>
        </button>
        <button
          onclick="closeAppointmentModal()"
          class="flex-1 px-3 py-2 text-sm text-gray-800 bg-gray-100 border border-gray-300 rounded-md md:text-base hover:bg-gray-200 md:flex-none"
        >
          <span class="flex items-center justify-center">
            <svg
              class="w-4 h-4 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
            Close
          </span>
        </button>
      </div>
    </div>
  </div>

  {% else %}
  <!-- Empty state when no businesses exist -->
  <div
    class="p-8 text-center bg-white border border-orange-200 rounded-lg shadow-md"
  >
    <svg
      class="w-16 h-16 mx-auto text-orange-400"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
      ></path>
    </svg>
    <h2 class="mt-4 text-xl font-medium text-gray-700">
      You don't have any businesses yet
    </h2>
    <p class="mt-2 text-gray-600">
      Get started by adding a new business listing
    </p>
    <a
      href="{{ url_for('add_business') }}"
      class="inline-block px-6 py-3 mt-6 font-medium text-white transition duration-300 bg-orange-600 rounded-lg hover:bg-orange-700"
    >
      Add Your First Business
    </a>
  </div>
  {% endif %}
</div>

<!-- Add this section after your existing content but before the closing div -->

<div
  id="verifyRewardModal"
  class="fixed inset-0 z-30 hidden w-full h-full overflow-y-auto bg-gray-600 bg-opacity-50"
>
  <div
    class="relative p-5 mx-auto bg-white border rounded-md shadow-lg top-20 w-96"
  >
    <div class="mt-3 text-center">
      <h3 class="text-lg font-medium leading-6 text-gray-900">
        Verify Loyalty Reward
      </h3>
      <div class="mt-4">
        <input
          type="text"
          id="rewardCode"
          placeholder="Enter redemption code"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500"
        />
        <div id="verificationResult" class="hidden mt-2 text-left">
          <!-- Results will be shown here -->
        </div>
      </div>
      <div class="flex justify-between mt-4">
        <button
          id="closeVerifyRewardModal"
          class="px-4 py-2 text-gray-800 bg-gray-200 rounded hover:bg-gray-300"
        >
          Cancel
        </button>
        <button
          id="verifyRewardButton"
          class="px-4 py-2 text-white bg-orange-500 rounded hover:bg-orange-600"
        >
          Verify
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Existing delete confirmation function
  function confirmDelete(businessId) {
    if (
      confirm(
        "Are you sure you want to delete this business? This action cannot be undone."
      )
    ) {
      const csrfToken = document
        .querySelector('meta[name="csrf-token"]')
        .getAttribute("content");

      fetch(`/api/delete-business/${businessId}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken,
        },
      })
        .then((response) => {
          if (response.ok) {
            window.location.reload();
          } else {
            alert("Failed to delete business. Please try again.");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred while trying to delete the business.");
        });
    }
  }

  // Appointment management code
  document.addEventListener("DOMContentLoaded", function () {
    const businessSelector = document.getElementById("business-selector");
    const dateFilter = document.getElementById("date-filter");
    const statusFilter = document.getElementById("status-filter");
    const searchField = document.getElementById("search-appointments");

    let currentPage = 1;
    const itemsPerPage = 10;
    let appointments = [];
    let filteredAppointments = [];

    // Load initial appointments for the first business
    if (businessSelector) {
      loadAppointments(businessSelector.value);

      // Set up event listeners
      businessSelector.addEventListener("change", function () {
        loadAppointments(this.value);
      });

      dateFilter.addEventListener("change", filterAppointments);
      statusFilter.addEventListener("change", filterAppointments);
      searchField.addEventListener("input", filterAppointments);
    }

    function loadAppointments(businessId) {
      const tableBody = document.getElementById("appointments-table-body");
      tableBody.innerHTML =
        '<tr><td colspan="6" class="px-6 py-4 text-sm text-center text-gray-500">Loading appointments...</td></tr>';

      fetch(`/api/business-appointments/${businessId}`)
        .then((response) => response.json())
        .then((data) => {
          appointments = data;
          filteredAppointments = [...appointments];
          currentPage = 1;
          filterAppointments();
        })
        .catch((error) => {
          console.error("Error loading appointments:", error);
          tableBody.innerHTML =
            '<tr><td colspan="6" class="px-6 py-4 text-sm text-center text-red-500">Error loading appointments. Please try again.</td></tr>';
        });
    }

    function filterAppointments() {
      const dateValue = dateFilter.value;
      const statusValue = statusFilter.value;
      const searchValue = searchField.value.toLowerCase();

      // Filter by date
      filteredAppointments = appointments.filter((appointment) => {
        const appointmentDate = new Date(appointment.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        const weekEnd = new Date(today);
        weekEnd.setDate(weekEnd.getDate() + 7);

        const monthEnd = new Date(today);
        monthEnd.setMonth(monthEnd.getMonth() + 1);

        let dateMatch = true;

        if (dateValue === "today") {
          dateMatch = appointmentDate >= today && appointmentDate < tomorrow;
        } else if (dateValue === "tomorrow") {
          dateMatch =
            appointmentDate >= tomorrow &&
            appointmentDate < new Date(tomorrow.getTime() + 86400000);
        } else if (dateValue === "week") {
          dateMatch = appointmentDate >= today && appointmentDate < weekEnd;
        } else if (dateValue === "month") {
          dateMatch = appointmentDate >= today && appointmentDate < monthEnd;
        }

        // Filter by status
        let statusMatch =
          statusValue === "all" || appointment.status === statusValue;

        // Filter by search text
        let searchMatch = true;
        if (searchValue) {
          searchMatch =
            (appointment.client_name &&
              appointment.client_name.toLowerCase().includes(searchValue)) ||
            (appointment.type &&
              appointment.type.toLowerCase().includes(searchValue)) ||
            (appointment.notes &&
              appointment.notes.toLowerCase().includes(searchValue));
        }

        return dateMatch && statusMatch && searchMatch;
      });

      // Sort by date (most recent first)
      filteredAppointments.sort((a, b) => new Date(a.date) - new Date(b.date));

      renderAppointments();
      updatePagination();
    }

    function renderAppointments() {
      const tableBody = document.getElementById("appointments-table-body");
      tableBody.innerHTML = "";

      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(
        startIndex + itemsPerPage,
        filteredAppointments.length
      );
      const pageAppointments = filteredAppointments.slice(startIndex, endIndex);

      if (pageAppointments.length === 0) {
        tableBody.innerHTML =
          '<tr><td colspan="6" class="px-6 py-4 text-sm text-center text-gray-500">No appointments found matching your criteria.</td></tr>';
        return;
      }

      pageAppointments.forEach((appointment) => {
        const row = document.createElement("tr");
        row.className = "hover:bg-gray-50 cursor-pointer";
        row.onclick = () => showAppointmentDetails(appointment);

        // Format date
        const appointmentDate = new Date(appointment.date);
        const formattedDate = appointmentDate.toLocaleDateString("en-US", {
          weekday: "short",
          month: "short",
          day: "numeric",
          year: "numeric",
        });

        // Format time
        const timeString = appointment.time || "";
        let formattedTime = "";
        if (timeString) {
          const [hours, minutes] = timeString.split(":");
          const time = new Date();
          time.setHours(parseInt(hours), parseInt(minutes));
          formattedTime = time.toLocaleTimeString("en-US", {
            hour: "numeric",
            minute: "2-digit",
            hour12: true,
          });
        }

        // Status badge
        const statusColors = {
          pending: "bg-yellow-100 text-yellow-800",
          confirmed: "bg-green-100 text-green-800",
          completed: "bg-blue-100 text-blue-800",
          cancelled: "bg-red-100 text-red-800",
        };

        const statusClass =
          statusColors[appointment.status] || "bg-gray-100 text-gray-800";

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${
              appointment.client_name || "Unknown"
            }</div>
            <div class="text-sm text-gray-500">${
              appointment.client_email || ""
            }</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${formattedDate}</div>
            <div class="text-sm text-gray-500">${formattedTime}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${
              appointment.type || "General"
            }</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
              ${appointment.status || "pending"}
            </span>
          </td>
          <td class="px-6 py-4 text-sm text-gray-500 whitespace-nowrap">
            ${appointment.client_phone || "No phone provided"}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex justify-center space-x-4">
              <button 
                class="px-3 py-1.5 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-md hover:bg-indigo-200 transition-colors" 
                onclick="event.stopPropagation(); showAppointmentDetails('${
                  appointment.id
                }')">
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                  View
                </div>
              </button>
              
              ${
                appointment.status !== "confirmed" &&
                appointment.status !== "completed" &&
                appointment.status !== "cancelled"
                  ? `<button 
                  class="px-3 py-1.5 text-sm font-medium text-green-700 bg-green-100 rounded-md hover:bg-green-200 transition-colors" 
                  onclick="event.stopPropagation(); updateAppointmentStatus('${appointment.id}', 'confirmed')">
                  <div class="flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Confirm
                  </div>
                </button>`
                  : ""
              }
              
              ${
                appointment.status !== "cancelled"
                  ? `<button 
                  class="px-3 py-1.5 text-sm font-medium text-red-700 bg-red-100 rounded-md hover:bg-red-200 transition-colors" 
                  onclick="event.stopPropagation(); updateAppointmentStatus('${appointment.id}', 'cancelled')">
                  <div class="flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    Cancel
                  </div>
                </button>`
                  : ""
              }
            </div>
          </td>
        `;

        tableBody.appendChild(row);
      });

      // Update pagination text
      document.getElementById("page-start").textContent = startIndex + 1;
      document.getElementById("page-end").textContent = endIndex;
      document.getElementById("total-results").textContent =
        filteredAppointments.length;

      // Update appointment count
      document.getElementById("appointment-count").textContent =
        filteredAppointments.length;
    }

    // Replace the updatePagination function with this improved version
    function updatePagination() {
      const totalPages = Math.ceil(filteredAppointments.length / itemsPerPage);
      const paginationContainer = document.getElementById(
        "pagination-container"
      );
      paginationContainer.innerHTML = "";

      // Only show pagination if there are multiple pages
      if (totalPages <= 1) {
        return;
      }

      // Previous button
      const prevButton = document.createElement("button");
      prevButton.className = `relative inline-flex items-center px-3 py-2 rounded-l-md border ${
        currentPage === 1
          ? "border-gray-300 bg-white text-gray-300 cursor-not-allowed"
          : "border-gray-300 bg-white text-gray-500 hover:bg-gray-50"
      }`;
      prevButton.innerHTML = `<span class="sr-only">Previous</span>
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>`;

      if (currentPage > 1) {
        prevButton.addEventListener("click", () => {
          currentPage--;
          renderAppointments();
          updatePagination();
        });
      }

      paginationContainer.appendChild(prevButton);

      // Page numbers - improved logic for better responsiveness
      const maxVisiblePages = window.innerWidth < 640 ? 3 : 5;
      let startPage = Math.max(
        1,
        currentPage - Math.floor(maxVisiblePages / 2)
      );
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      // First page button (if not in visible range)
      if (startPage > 1) {
        const firstPageBtn = document.createElement("button");
        firstPageBtn.className =
          "relative inline-flex items-center px-4 py-2 border bg-white border-gray-300 text-gray-500 hover:bg-gray-50";
        firstPageBtn.textContent = "1";
        firstPageBtn.addEventListener("click", () => {
          currentPage = 1;
          renderAppointments();
          updatePagination();
        });
        paginationContainer.appendChild(firstPageBtn);

        // Ellipsis (if needed)
        if (startPage > 2) {
          const ellipsis = document.createElement("span");
          ellipsis.className =
            "relative inline-flex items-center px-4 py-2 border bg-white border-gray-300 text-gray-700";
          ellipsis.textContent = "…";
          paginationContainer.appendChild(ellipsis);
        }
      }

      // Visible page buttons
      for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement("button");
        pageButton.className = `relative inline-flex items-center px-4 py-2 border ${
          i === currentPage
            ? "bg-orange-50 border-orange-500 text-orange-600 z-10 font-medium"
            : "bg-white border-gray-300 text-gray-500 hover:bg-gray-50"
        }`;
        pageButton.textContent = i;

        if (i !== currentPage) {
          pageButton.addEventListener("click", () => {
            currentPage = i;
            renderAppointments();
            updatePagination();
          });
        }

        paginationContainer.appendChild(pageButton);
      }

      // Last page button (if not in visible range)
      if (endPage < totalPages) {
        // Ellipsis (if needed)
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement("span");
          ellipsis.className =
            "relative inline-flex items-center px-4 py-2 border bg-white border-gray-300 text-gray-700";
          ellipsis.textContent = "…";
          paginationContainer.appendChild(ellipsis);
        }

        const lastPageBtn = document.createElement("button");
        lastPageBtn.className =
          "relative inline-flex items-center px-4 py-2 border bg-white border-gray-300 text-gray-500 hover:bg-gray-50";
        lastPageBtn.textContent = totalPages;
        lastPageBtn.addEventListener("click", () => {
          currentPage = totalPages;
          renderAppointments();
          updatePagination();
        });
        paginationContainer.appendChild(lastPageBtn);
      }

      // Next button
      const nextButton = document.createElement("button");
      nextButton.className = `relative inline-flex items-center px-3 py-2 rounded-r-md border ${
        currentPage === totalPages
          ? "border-gray-300 bg-white text-gray-300 cursor-not-allowed"
          : "border-gray-300 bg-white text-gray-500 hover:bg-gray-50"
      }`;
      nextButton.innerHTML = `<span class="sr-only">Next</span>
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>`;

      if (currentPage < totalPages) {
        nextButton.addEventListener("click", () => {
          currentPage++;
          renderAppointments();
          updatePagination();
        });
      }

      paginationContainer.appendChild(nextButton);
    }

    // Appointment details modal
    window.showAppointmentDetails = function (appointmentId) {
      const appointment = appointments.find((a) => a.id === appointmentId);
      if (!appointment) return;

      const modal = document.getElementById("appointment-modal");
      const detailsContainer = document.getElementById("appointment-details");

      // Format date and time
      const appointmentDate = new Date(appointment.date);
      const formattedDate = appointmentDate.toLocaleDateString("en-US", {
        weekday: "long",
        month: "long",
        day: "numeric",
        year: "numeric",
      });

      let formattedTime = "No time specified";
      if (appointment.time) {
        const [hours, minutes] = appointment.time.split(":");
        const time = new Date();
        time.setHours(parseInt(hours), parseInt(minutes));
        formattedTime = time.toLocaleTimeString("en-US", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        });
      }

      // Get status class for display
      const statusColors = {
        pending: "bg-yellow-100 text-yellow-800 border-yellow-200",
        confirmed: "bg-green-100 text-green-800 border-green-200",
        completed: "bg-blue-100 text-blue-800 border-blue-200",
        cancelled: "bg-red-100 text-red-800 border-red-200",
      };

      const statusClass =
        statusColors[appointment.status] ||
        "bg-gray-100 text-gray-800 border-gray-200";

      // Build appointment details HTML with improved layout
      detailsContainer.innerHTML = `
        <div class="space-y-5">
          <!-- Status Banner -->
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900">Appointment #${appointment.id.substring(
              0,
              8
            )}</h2>
            <span class="px-3 py-1 text-xs font-medium rounded-full uppercase ${statusClass}">
              ${appointment.status || "pending"}
            </span>
          </div>

          <!-- Client & Date/Time Info Cards -->
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <!-- Client Information Card -->
            <div class="p-4 bg-white border rounded-lg shadow-sm">
              <div class="flex items-center mb-3">
                <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <h4 class="text-sm font-medium text-gray-700">Client Information</h4>
              </div>
              <div class="space-y-2">
                <p class="text-lg font-semibold text-gray-900">${
                  appointment.client_name || "Unknown"
                }</p>
                ${
                  appointment.client_email
                    ? `
                  <div class="flex items-center text-sm text-gray-600">
                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <h4 class="text-sm font-medium text-gray-700">Client Information</h4>
                  </div>
                  <span class="truncate">${appointment.client_email}</span>
                `
                    : ""
                }
                ${
                  appointment.client_phone
                    ? `
                  <div class="flex items-center text-sm text-gray-600">
                    <svg class="w-4 h-4 mr-1.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    <span>Phone: ${appointment.client_phone}</span>
                  </div>
                `
                    : ""
                }
              </div>
            </div>

            <!-- Appointment Details Card -->
            <div class="p-4 bg-white border rounded-lg shadow-sm">
              <div class="flex items-center mb-3">
                <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <h4 class="text-sm font-medium text-gray-700">Appointment Details</h4>
              </div>
              <!-- Horizontal line with gap -->
              <hr class="my-3 border-t border-gray-200">
              <div class="grid grid-cols-1 gap-2 text-sm md:text-base">
                <div class="flex items-start">
                  <svg class="w-4 h-4 mt-0.5 mr-1.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  <div>
                    <span class="font-medium">Date:</span>
                    <span>${formattedDate}</span>
                  </div>
                </div>
                <div class="flex items-start">
                  <svg class="w-4 h-4 mt-0.5 mr-1.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div>
                    <span class="font-medium">Time:</span>
                    <span>${formattedTime}</span>
                  </div>
                </div>
                <div class="flex items-start">
                  <svg class="w-4 h-4 mt-0.5 mr-1.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                  </svg>
                  <div>
                    <span class="font-medium">Type:</span>
                    <span>${appointment.type || "General"}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Notes Section -->
          ${
            appointment.notes
              ? `
            <div class="p-4 bg-white border rounded-lg shadow-sm">
              <div class="flex items-center mb-2">
                <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h4 class="text-sm font-medium text-gray-700">Notes</h4>
              </div>
              <div class="p-3 text-sm border border-gray-100 rounded bg-gray-50">
                ${appointment.notes}
              </div>
            </div>
          `
              : ""
          }
          
          <!-- Appointment History Timeline -->
          <div class="p-4 bg-white border rounded-lg shadow-sm">
            <div class="flex items-center mb-2">
              <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <h4 class="text-sm font-medium text-gray-700">Appointment History</h4>
            </div>
            
            <div class="relative pl-6 mt-3">
              <!-- Timeline line -->
              <div class="absolute top-0 left-2 h-full w-0.5 bg-gray-200"></div>
              
              <!-- Created status -->
              <div class="relative mb-4">
                <div class="absolute w-4 h-4 mt-1 bg-orange-500 border-2 border-white rounded-full shadow -left-6"></div>
                <div class="pl-4">
                  <p class="text-xs text-gray-500">Created</p>
                  <p class="text-sm">${new Date(
                    appointment.created_at || Date.now()
                  ).toLocaleString()}</p>
                </div>
              </div>
              
              <!-- Status updates -->
              ${
                appointment.status_updates && appointment.status_updates.length
                  ? appointment.status_updates
                      .map((update) => {
                        // Debugging: Log the status of each update
                        console.log("Update Status:", update.status);

                        // Status specific styling
                        const statusColors = {
                          pending: "bg-yellow-500",
                          confirmed: "bg-green-500",
                          completed: "bg-blue-500",
                          cancelled: "bg-red-500",
                        };
                        const dotColor =
                          statusColors[update.status] || "bg-gray-500";

                        // Format timestamp
                        let displayDate;
                        try {
                          if (update.timestamp && update.timestamp.seconds) {
                            displayDate = new Date(
                              update.timestamp.seconds * 1000
                            );
                          } else if (
                            update.timestamp &&
                            typeof update.timestamp === "string"
                          ) {
                            displayDate = new Date(update.timestamp);
                          } else {
                            displayDate = new Date();
                          }
                        } catch (e) {
                          displayDate = new Date();
                        }

                        return `
                        <div class="relative mb-4">
                          <div class="absolute -left-6 mt-1 w-4 h-4 rounded-full ${dotColor} border-2 border-white shadow"></div>
                          <div class="pl-4">
                            <p class="text-xs text-gray-500">Status changed to: <span class="font-medium">${
                              update.status
                            }</span></p>
                            <p class="text-sm">${displayDate.toLocaleString()}</p>
                            ${
                              update.note
                                ? `<p class="p-2 mt-1 text-sm italic rounded bg-gray-50">"${update.note}"</p>`
                                : ""
                            }
                          </div>
                        </div>
                      `;
                      })
                      .join("")
                  : '<div class="pl-4 text-sm text-gray-500">No status updates yet</div>'
              }
            </div>
          </div>
        </div>
      `;

      // Configure action buttons based on current status
      const cancelBtn = document.getElementById("modal-cancel");
      const confirmBtn = document.getElementById("modal-confirm");
      const completeBtn = document.getElementById("modal-complete");

      // Reset button visibility
      cancelBtn.style.display = "block";
      confirmBtn.style.display = "block";
      completeBtn.style.display = "block";

      // Set appropriate button visibility based on current status
      switch (appointment.status) {
        case "cancelled":
          cancelBtn.style.display = "none";
          confirmBtn.style.display = "none";
          completeBtn.style.display = "none";
          break;
        case "confirmed":
          confirmBtn.style.display = "none";
          break;
        case "completed":
          confirmBtn.style.display = "none";
          completeBtn.style.display = "none";
          break;
        default: // pending
          break;
      }

      // Configure button actions
      cancelBtn.onclick = () =>
        updateAppointmentStatus(appointment.id, "cancelled");
      confirmBtn.onclick = () =>
        updateAppointmentStatus(appointment.id, "confirmed");
      completeBtn.onclick = () =>
        updateAppointmentStatus(appointment.id, "completed");

      // Show modal
      modal.classList.remove("hidden");
    };

    window.updateAppointmentStatus = function (appointmentId, newStatus) {
      const csrfToken = document
        .querySelector('meta[name="csrf-token"]')
        .getAttribute("content");

      // Show confirmation based on status
      let confirmMsg = "";
      let statusNote = "";

      switch (newStatus) {
        case "confirmed":
          confirmMsg = "Confirm this appointment?";
          break;
        case "cancelled":
          confirmMsg = "Cancel this appointment?";
          statusNote = prompt(
            "Please provide a reason for cancellation (optional):"
          );
          break;
        case "completed":
          confirmMsg = "Mark this appointment as completed?";
          statusNote = prompt(
            "Add any notes about this completed appointment (optional):"
          );
          break;
        default:
          confirmMsg = `Change appointment status to ${newStatus}?`;
      }

      if (!confirm(confirmMsg)) {
        return;
      }

      // Update UI to show loading state
      const modal = document.getElementById("appointment-modal");
      modal.classList.add("opacity-50", "pointer-events-none");

      // Make API call to update status
      fetch(`/api/update-appointment-status/${appointmentId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken,
        },
        body: JSON.stringify({
          status: newStatus,
          note: statusNote,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Update local data
            const index = appointments.findIndex((a) => a.id === appointmentId);
            if (index !== -1) {
              appointments[index].status = newStatus;

              // Add status update to history if it doesn't exist
              if (!appointments[index].status_updates) {
                appointments[index].status_updates = [];
              }

              appointments[index].status_updates.push({
                status: newStatus,
                timestamp: new Date().toISOString(),
                note: statusNote,
              });

              // Re-filter and re-render
              filterAppointments();

              // Update modal if still open
              if (!modal.classList.contains("hidden")) {
                showAppointmentDetails(appointmentId);
              }

              // Show success message
              const message = document.createElement("div");
              message.className =
                "fixed bottom-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-lg z-50";
              message.innerHTML = `<p>Appointment successfully updated to <strong>${newStatus}</strong></p>`;
              document.body.appendChild(message);

              // Remove message after 3 seconds
              setTimeout(() => {
                message.remove();
              }, 3000);
            }
          } else {
            alert(`Error: ${data.error || "Failed to update appointment"}`);
          }

          // Remove loading state
          modal.classList.remove("opacity-50", "pointer-events-none");
        })
        .catch((error) => {
          console.error("Error updating appointment status:", error);
          alert(
            "An error occurred while updating the appointment. Please try again."
          );
          modal.classList.remove("opacity-50", "pointer-events-none");
        });
    };

    // Export appointments to CSV
    document
      .getElementById("export-csv")
      .addEventListener("click", function () {
        // Create CSV content
        const headers = [
          "Date",
          "Time",
          "Client Name",
          "Client Email",
          "Client Phone",
          "Type",
          "Status",
          "Notes",
        ];
        let csvContent = headers.join(",") + "\n";

        // Add data rows
        filteredAppointments.forEach((appointment) => {
          const dateStr = new Date(appointment.date).toLocaleDateString();
          const row = [
            `"${dateStr}"`,
            `"${appointment.time || ""}"`,
            `"${appointment.client_name || ""}"`,
            `"${appointment.client_email || ""}"`,
            `"${appointment.client_phone || ""}"`,
            `"${appointment.type || ""}"`,
            `"${appointment.status || ""}"`,
            `"${
              appointment.notes ? appointment.notes.replace(/"/g, '""') : ""
            }"`, // Escape quotes in notes
          ];
          csvContent += row.join(",") + "\n";
        });

        // Create and trigger download
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `appointments-${new Date().toISOString().split("T")[0]}.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

    // Calendar functionality
    let currentCalendarDate = new Date();
    const calendarMonthYear = document.getElementById("calendar-month-year");
    const calendarGrid = document.getElementById("calendar-grid");
    const prevMonthButton = document.getElementById("prev-month");
    const nextMonthButton = document.getElementById("next-month");
    const todayButton = document.getElementById("today-button");

    // Initialize calendar
    renderCalendar(currentCalendarDate);

    // Set up calendar navigation
    if (prevMonthButton && nextMonthButton && todayButton) {
      prevMonthButton.addEventListener("click", () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        renderCalendar(currentCalendarDate);
      });

      nextMonthButton.addEventListener("click", () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        renderCalendar(currentCalendarDate);
      });

      todayButton.addEventListener("click", () => {
        currentCalendarDate = new Date();
        renderCalendar(currentCalendarDate);
      });
    }

    function renderCalendar(date) {
      if (!calendarGrid || !calendarMonthYear) return;

      // Update month/year display
      const monthYearString = date.toLocaleDateString("en-US", {
        month: "long",
        year: "numeric",
      });
      calendarMonthYear.textContent = monthYearString;

      // Clear existing calendar
      calendarGrid.innerHTML = "";

      // Get first day of month and total days
      const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
      const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);

      // Calculate days from previous month to display
      const daysFromPrevMonth = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.

      // Calculate total cells needed (previous month days + current month days)
      const totalDays = daysFromPrevMonth + lastDay.getDate();
      const totalCells = Math.ceil(totalDays / 7) * 7; // Ensure complete rows

      // Current date for highlighting today
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Group appointments by date for quick lookup
      const appointmentsByDate = {};
      filteredAppointments.forEach((appointment) => {
        const appointmentDate = new Date(appointment.date);
        const dateKey = appointmentDate.toISOString().split("T")[0];

        if (!appointmentsByDate[dateKey]) {
          appointmentsByDate[dateKey] = [];
        }
        appointmentsByDate[dateKey].push(appointment);
      });

      // Create calendar cells
      for (let i = 0; i < totalCells; i++) {
        const dayCell = document.createElement("div");
        dayCell.className = "min-h-[100px] p-1 border border-gray-200 relative";

        const cellDate = new Date(
          date.getFullYear(),
          date.getMonth(),
          i - daysFromPrevMonth + 1
        );
        const isCurrentMonth = cellDate.getMonth() === date.getMonth();
        const isToday = cellDate.getTime() === today.getTime();

        const dateKey = cellDate.toISOString().split("T")[0];
        const dayAppointments = appointmentsByDate[dateKey] || [];
        const hasAppointments = dayAppointments.length > 0;

        // Day number
        const dayNumber = document.createElement("div");
        dayNumber.className = `text-right text-sm ${
          isCurrentMonth ? "font-medium" : "text-gray-400"
        }`;
        if (isToday) {
          dayNumber.className +=
            " bg-orange-500 text-white rounded-full w-6 h-6 flex items-center justify-center ml-auto";
        }
        dayNumber.textContent = cellDate.getDate();
        dayCell.appendChild(dayNumber);

        // Add appointment indicators if there are any for this day
        if (hasAppointments && isCurrentMonth) {
          const appointmentCountByStatus = {
            pending: 0,
            confirmed: 0,
            completed: 0,
            cancelled: 0,
          };

          dayAppointments.forEach((appointment) => {
            const status = appointment.status || "pending";
            appointmentCountByStatus[status] =
              (appointmentCountByStatus[status] || 0) + 1;
          });

          // Create appointment summary
          const appointmentSummary = document.createElement("div");
          appointmentSummary.className = "mt-1 space-y-1";

          // Add dots for each status with appointments
          Object.entries(appointmentCountByStatus).forEach(
            ([status, count]) => {
              if (count > 0) {
                const statusColors = {
                  pending: "bg-yellow-500",
                  confirmed: "bg-green-500",
                  completed: "bg-blue-500",
                  cancelled: "bg-red-500",
                };

                const statusDot = document.createElement("div");
                statusDot.className =
                  "flex items-center cursor-pointer hover:bg-gray-100 rounded p-0.5";
                statusDot.innerHTML = `
                <span class="inline-block w-2 h-2 mr-1 rounded-full ${
                  statusColors[status]
                }"></span>
                <span class="text-xs text-gray-600">${count} ${
                  count === 1 ? "appt" : "appts"
                }</span>
              `;

                // Add click handler to filter by this date and status
                statusDot.addEventListener("click", () => {
                  // Set date filter to specific date
                  dateFilter.value = "all"; // Reset the default filter first

                  // Set status filter if needed
                  if (status !== "all") {
                    statusFilter.value = status;
                  }

                  // Apply custom date filter for this specific day
                  const specificDay = cellDate;
                  const nextDay = new Date(specificDay);
                  nextDay.setDate(nextDay.getDate() + 1);

                  // Override the filter function temporarily
                  const originalFilterFunction = filterAppointments;
                  filterAppointments = () => {
                    filteredAppointments = appointments.filter(
                      (appointment) => {
                        const appointmentDate = new Date(appointment.date);
                        const dateMatch =
                          appointmentDate >= specificDay &&
                          appointmentDate < nextDay;
                        const statusMatch =
                          status === "all" || appointment.status === status;
                        return dateMatch && statusMatch;
                      }
                    );

                    renderAppointments();
                    updatePagination();
                  };

                  // Apply the filter
                  filterAppointments();

                  // Restore original filter function
                  setTimeout(() => {
                    filterAppointments = originalFilterFunction;
                  }, 100);

                  // Scroll to the appointment table
                  document
                    .querySelector(".overflow-x-auto.rounded-lg.shadow")
                    .scrollIntoView({
                      behavior: "smooth",
                    });
                });

                appointmentSummary.appendChild(statusDot);
              }
            }
          );

          dayCell.appendChild(appointmentSummary);
        }

        calendarGrid.appendChild(dayCell);
      }
    }

    // Update calendar when appointment data changes
    const originalFilterAppointments = filterAppointments;
    filterAppointments = function () {
      originalFilterAppointments();
      renderCalendar(currentCalendarDate);
    };

    // Initialize FullCalendar
    let calendarEl = document.getElementById("calendar");
    if (calendarEl) {
      let calendarInstance = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: "auto",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,listMonth",
        },
        views: {
          dayGrid: {
            dayMaxEventRows: 3,
          },
        },
        eventTimeFormat: {
          hour: "2-digit",
          minute: "2-digit",
          meridiem: "short",
        },
        eventClick: function (info) {
          // Find the appointment and show details
          const appointment = appointments.find((a) => a.id === info.event.id);
          if (appointment) {
            showAppointmentDetails(appointment.id);
          }
        },
        eventClassNames: function (arg) {
          // Add custom classes based on appointment status
          switch (arg.event.extendedProps.status) {
            case "confirmed":
              return ["border-green-500", "bg-green-100", "text-green-800"];
            case "pending":
              return ["border-yellow-500", "bg-yellow-100", "text-yellow-800"];
            case "completed":
              return ["border-blue-500", "bg-blue-100", "text-blue-800"];
            case "cancelled":
              return [
                "border-red-500",
                "bg-red-100",
                "text-red-800",
                "line-through",
              ];
            default:
              return ["border-gray-500", "bg-gray-100", "text-gray-800"];
          }
        },
      });

      calendarInstance.render();

      // Function to update calendar events when appointments change
      function updateCalendarEvents() {
        // Remove all events
        calendarInstance.removeAllEvents();

        // Add events from filteredAppointments
        const events = filteredAppointments.map((appointment) => {
          // Handle appointment date and time
          let startDate = new Date(appointment.date);

          // If time is specified, set it on the date
          if (appointment.time) {
            const [hours, minutes] = appointment.time.split(":");
            startDate.setHours(parseInt(hours), parseInt(minutes), 0);
          }

          // Create event object for FullCalendar
          return {
            id: appointment.id,
            title: `${appointment.client_name || "Unknown"} - ${
              appointment.type || "General"
            }`,
            start: startDate,
            allDay: !appointment.time,
            extendedProps: {
              status: appointment.status || "pending",
              client: appointment.client_name,
              phone: appointment.client_phone,
              email: appointment.client_email,
              type: appointment.type,
            },
          };
        });

        calendarInstance.addEventSource(events);
      }

      // Update calendar when appointments are loaded or filtered
      const originalFilterFunction = filterAppointments;
      filterAppointments = function () {
        originalFilterFunction();
        updateCalendarEvents();
      };

      // Update calendar when business selector changes
      businessSelector.addEventListener("change", function () {
        setTimeout(updateCalendarEvents, 500); // Wait for appointments to load
      });
    }
  });

  window.closeAppointmentModal = function () {
    document.getElementById("appointment-modal").classList.add("hidden");
  };

  // Add after your existing business card setup
  document.querySelectorAll(".business-card").forEach((card) => {
    const businessId = card.getAttribute("data-id");
    const businessActions = card.querySelector(".business-actions");

    if (businessActions) {
      const verifyButton = document.createElement("button");
      verifyButton.className =
        "verify-reward px-3 py-1 bg-green-100 text-green-700 rounded-full hover:bg-green-200";
      verifyButton.innerHTML =
        '<i class="mr-1 fas fa-check"></i> Verify Reward';
      verifyButton.setAttribute("data-id", businessId);
      businessActions.appendChild(verifyButton);

      verifyButton.addEventListener("click", () => {
        document.getElementById("verifyRewardModal").classList.remove("hidden");
        currentBusinessId = businessId;
      });
    }
  });

  // Add verification handling
  document
    .getElementById("closeVerifyRewardModal")
    .addEventListener("click", () => {
      document.getElementById("verifyRewardModal").classList.add("hidden");
      document.getElementById("verificationResult").classList.add("hidden");
      document.getElementById("rewardCode").value = "";
    });

  document
    .getElementById("verifyRewardButton")
    .addEventListener("click", () => {
      const code = document.getElementById("rewardCode").value.trim();
      if (!code) {
        alert("Please enter a redemption code");
        return;
      }

      // Get CSRF token
      const csrfToken = document
        .querySelector('meta[name="csrf-token"]')
        ?.getAttribute("content");

      // Verify the code
      fetch("/api/verify-reward-code", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken || "",
        },
        body: JSON.stringify({
          code: code,
          business_id: currentBusinessId,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          const resultDiv = document.getElementById("verificationResult");
          resultDiv.classList.remove("hidden");

          if (data.valid) {
            resultDiv.innerHTML = `
          <div class="p-3 border border-green-200 rounded bg-green-50">
            <p class="font-medium text-green-700">✅ Valid Redemption</p>
            <p class="mt-1 text-sm">Customer: ${data.user_email}</p>
            <p class="text-sm">Reward: ${data.reward}</p>
            <p class="mt-2 text-xs text-green-600">Redeem now?</p>
            <div class="mt-2">
              <button id="confirmRedemption" class="px-3 py-1 text-white bg-green-500 rounded hover:bg-green-600">
                Mark as Redeemed
              </button>
            </div>
          </div>
        `;

            document
              .getElementById("confirmRedemption")
              .addEventListener("click", () => {
                // Mark as redeemed
                fetch("/api/mark-reward-redeemed", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-Token": csrfToken || "",
                  },
                  body: JSON.stringify({
                    code: code,
                    business_id: currentBusinessId,
                  }),
                })
                  .then((response) => response.json())
                  .then((result) => {
                    if (result.success) {
                      alert("Reward successfully marked as redeemed!");
                      document
                        .getElementById("verifyRewardModal")
                        .classList.add("hidden");
                      document.getElementById("rewardCode").value = "";
                      document
                        .getElementById("verificationResult")
                        .classList.add("hidden");
                    } else {
                      alert(
                        "Error: " +
                          (result.error || "Failed to mark reward as redeemed")
                      );
                    }
                  })
                  .catch((error) => {
                    console.error("Error:", error);
                    alert("An error occurred while processing the redemption");
                  });
              });
          } else {
            resultDiv.innerHTML = `
          <div class="p-3 border border-red-200 rounded bg-red-50">
            <p class="font-medium text-red-700">❌ Invalid Code</p>
            <p class="mt-1 text-sm">${
              data.error || "This code is not valid or has already been used."
            }</p>
          </div>
        `;
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          document.getElementById("verificationResult").innerHTML = `
        <div class="p-3 border border-red-200 rounded bg-red-50">
          <p class="font-medium text-red-700">❌ Error</p>
          <p class="mt-1 text-sm">An error occurred while verifying the code.</p>
        </div>
      `;
          document
            .getElementById("verificationResult")
            .classList.remove("hidden");
        });
    });
</script>
{% endblock %}
